<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title }}</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" />
  <link href="https://cdn.jsdelivr.net/npm/video.js@8.6.1/dist/video-js.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/video.js@8.6.1/dist/video.min.js" async></script>
  <style>
    :root {
      color-scheme: light;
    }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", "Roboto", "Helvetica Neue", "Arial", "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      background-color: #f5f7fb;
      color: #1f2937;
    }
    .layout {
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      gap: 1.5rem;
    }
    @media (max-width: 1280px) and (min-width: 769px) {
      /* md到xl区间：保持按钮在一行 */
      .layout {
        grid-template-columns: 1fr;
      }
      .mx-auto {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      header {
        gap: 1rem;
      }
      header > div:last-child {
        flex-direction: row;
        gap: 1rem;
        flex-wrap: nowrap;
      }
      .search-box {
        max-width: none;
        flex: 1;
      }
      .action-button {
        padding: 12px 18px;
        font-size: 15px;
        min-height: 44px;
        white-space: nowrap;
      }
    }
    @media (max-width: 768px) {
      /* 平板和手机：按钮分两行 */
      .layout {
        grid-template-columns: 1fr;
      }
      .mx-auto {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      header {
        gap: 1rem;
      }
      header > div:last-child {
        flex-direction: column;
        gap: 0.75rem;
      }
      .search-box {
        max-width: none;
      }
      .action-button {
        padding: 14px 24px;
        font-size: 16px;
        justify-content: center;
        min-height: 52px;
        width: 100%;
      }
      .action-button span {
        display: block;
      }
    }
    @media (max-width: 640px) {
      .mx-auto {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
      }
      header h1 {
        font-size: 1.5rem;
      }
      .search-box input {
        padding: 14px 40px 14px 16px;
        font-size: 16px;
        min-height: 52px;
        box-sizing: border-box;
      }
      .action-button {
        padding: 16px 28px;
        border-radius: 16px;
        font-size: 17px;
        min-height: 56px;
        font-weight: 600;
      }
      table {
        font-size: 14px;
        border-collapse: separate;
        border-spacing: 0;
      }
      table thead {
        display: none;
      }
      table tbody tr {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(120px, 34%);
        grid-template-rows: auto auto;
        grid-template-areas:
          "name actions"
          "meta actions";
        gap: 0.45rem 0.75rem;
        padding: 14px 16px;
        background: #ffffff;
        border-bottom: 1px solid #e2e8f0;
        align-items: start;
      }
      table tbody tr:hover {
        background-color: #ffffff;
      }
      table tbody td {
        padding: 0;
        border-bottom: none;
      }
      .name-cell {
        grid-area: name;
        max-width: none;
        font-size: 15px;
        line-height: 1.35;
      }
      .name-cell .truncate {
        white-space: normal;
      }
      .meta-info-cell {
        grid-area: meta;
        display: block !important;
        padding: 0;
        margin: 0;
      }
      .meta-info {
        display: flex !important;
        flex-wrap: wrap;
        gap: 0.35rem 0.65rem;
        font-size: 13px;
        color: #475569;
      }
      .meta-info span {
        display: inline-flex;
        align-items: center;
      }
      /* .meta-info span + span::before {
         content: "·";
         margin-right: 0.35rem;
         color: #cbd5e1;
       } */
      .action-cell {
        grid-area: actions;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: center;
        gap: 0.4rem;
        text-align: right;
      }
      .actions {
        white-space: normal;
      }
      .actions .action-control {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        line-height: 1.2;
        border: 1px solid transparent;
        box-shadow: 0 6px 16px -12px rgba(15, 23, 42, 0.45);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        margin: 0;
        min-width: 120px;
        max-width: 200px;
        width: auto;
      }
      .actions .action-control:active {
        transform: scale(0.98);
      }
      .actions .preview-link,
      .actions .open-link,
      .actions .download-link {
        background: linear-gradient(135deg, var(--tp-blue) 0%, var(--tp-pink) 100%);
        color: #0b1220;
        border-color: rgba(91, 207, 250, 0.55);
      }
      .actions .jump-link {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #166534;
      }
      .actions .action-control + .action-control {
        margin-left: 0;
      }
      .mobile-hide {
        display: none;
      }
    }
    @media (max-width: 480px) {
      table tbody tr {
        grid-template-columns: minmax(0, 1fr) minmax(100px, 45%);
        padding: 12px 14px;
        gap: 0.5rem 0.75rem;
      }
      .name-cell {
        font-size: 14px;
      }
      .meta-info {
        font-size: 12px;
      }
      .actions .action-control {
        font-size: 13px;
        padding: 10px 12px;
        min-width: 110px;
        max-width: 160px;
      }
    }
    .panel {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      box-shadow: 0 12px 24px -16px rgba(15, 23, 42, 0.4);
    }
    .group-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .group-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    .group-item:hover {
      background-color: #f1f5f9;
      border-color: #cbd5f5;
    }
    .group-item.active {
      background-color: #e0edff;
      border-color: #93c5fd;
    }
    .group-item__alias {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-strong);
    }
    .group-item__meta {
      font-size: 12px;
      color: var(--muted-2);
    }
    .group-item__meta span + span::before {
      content: " · ";
      color: var(--border);
      margin: 0 4px;
    }
    .search-box input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      padding: 10px 40px 10px 16px;
      font-size: 14px;
      color: #1f2937;
      box-shadow: 0 8px 24px -18px rgba(15, 23, 42, 0.6);
    }
    .search-box svg {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #64748b;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table thead th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #475569;
      background-color: #f8fafc;
      padding: 12px;
      text-align: left;
    }
    .uploader-column {
      width: 10rem;
      max-width: 10rem;
    }
    table tbody td {
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      vertical-align: middle;
      color: #334155;
    }
    table tbody tr:hover {
      background-color: #f8fafc;
    }
    .actions a,
    .actions button {
      font-size: 13px;
      color: #2563eb;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin: 0 4px;
    }
    .actions a:hover,
    .actions button:hover {
       color: #1e40af;
     }
    .meta-info {
      display: none;
    }
    .meta-info-cell {
      padding-left: 1.5rem;
      display: none;
    }
     .name-cell {
        max-width: 300px;
        word-wrap: break-word;
        word-break: break-all;
        white-space: normal;
        line-height: 1.4;
      }
      .action-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        outline: none;
      }
      .action-button.primary {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        color: white;
        box-shadow: 0 4px 12px -4px rgba(14, 165, 233, 0.4);
      }
      .action-button.primary:hover {
        background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
        box-shadow: 0 6px 16px -4px rgba(14, 165, 233, 0.5);
        transform: translateY(-1px);
      }
      .action-button.primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px -2px rgba(14, 165, 233, 0.4);
      }
      .action-button.secondary {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        color: #475569;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px -4px rgba(15, 23, 42, 0.1);
      }
      .action-button.secondary:hover {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        color: #334155;
        border-color: #cbd5e1;
        box-shadow: 0 4px 12px -4px rgba(15, 23, 42, 0.15);
        transform: translateY(-1px);
      }
      .action-button.secondary:active {
        transform: translateY(0);
        box-shadow: 0 1px 4px -2px rgba(15, 23, 42, 0.1);
      }
      .action-button svg {
        transition: transform 0.3s ease;
      }
      .action-button.refresh:hover svg {
         transform: rotate(180deg);
       }
       .modal-overlay {
         position: fixed;
         top: 0;
         left: 0;
         right: 0;
         bottom: 0;
         background: rgba(0, 0, 0, 0.5);
         backdrop-filter: blur(4px);
         display: flex;
         align-items: center;
         justify-content: center;
         z-index: 1000;
         opacity: 1;
         transition: opacity 0.2s ease;
       }
       .modal-overlay.hidden {
         opacity: 0;
         pointer-events: none;
       }
       .modal-content {
         background: white;
         border-radius: 16px;
         box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
         max-width: 400px;
         width: 90vw;
         max-height: 90vh;
         overflow: hidden;
         transform: scale(1);
         transition: transform 0.2s ease;
       }
       .modal-overlay.hidden .modal-content {
         transform: scale(0.95);
       }
       .modal-header {
         display: flex;
         align-items: center;
         justify-content: space-between;
         padding: 20px 24px 16px;
         border-bottom: 1px solid #e2e8f0;
       }
       .modal-title {
         font-size: 18px;
         font-weight: 600;
         color: #1e293b;
         margin: 0;
       }
       .modal-close-btn {
         background: none;
         border: none;
         color: #64748b;
         cursor: pointer;
         padding: 4px;
         border-radius: 6px;
         transition: all 0.2s ease;
       }
       .modal-close-btn:hover {
         background: #f1f5f9;
         color: #334155;
       }
       .modal-body {
         padding: 24px;
         text-align: center;
       }
       .modal-icon {
         margin-bottom: 16px;
         display: flex;
         justify-content: center;
       }
       .modal-text {
         margin-bottom: 8px;
       }
       .modal-message {
         font-size: 16px;
         color: #334155;
         margin: 0 0 8px 0;
       }
       .modal-filename {
         font-size: 14px;
         color: #64748b;
         margin: 0;
         word-break: break-all;
         background: #f8fafc;
         padding: 8px 12px;
         border-radius: 8px;
         border: 1px solid #e2e8f0;
       }
       .modal-footer {
         display: flex;
         gap: 12px;
         padding: 16px 24px 24px;
         justify-content: flex-end;
       }
       .modal-btn {
         display: inline-flex;
         align-items: center;
         gap: 6px;
         padding: 10px 16px;
         border-radius: 8px;
         font-size: 14px;
         font-weight: 500;
         text-decoration: none;
         cursor: pointer;
         transition: all 0.2s ease;
         border: none;
       }
       .modal-btn-secondary {
         background: #f8fafc;
         color: #64748b;
         border: 1px solid #e2e8f0;
       }
       .modal-btn-secondary:hover {
         background: #f1f5f9;
         color: #475569;
         border-color: #cbd5e1;
       }
       .modal-btn-primary {
         background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
         color: white;
         border: 1px solid transparent;
         box-shadow: 0 2px 4px -1px rgba(14, 165, 233, 0.3);
       }
       .modal-btn-primary:hover {
          background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
          box-shadow: 0 4px 8px -2px rgba(14, 165, 233, 0.4);
          transform: translateY(-1px);
        }
        /* 跳转高亮闪烁效果 */
        .jump-highlight {
          animation: jumpFlash 1s ease-in-out 3;
        }
        @keyframes jumpFlash {
          0%, 100% { background-color: transparent; }
          25%, 75% { background-color: #fef3c7; }
          50% { background-color: #fde68a; }
        }
        
        /* Video.js 自定义样式 */
        .video-js {
          width: 100%;
          height: auto;
          max-width: 100%;
          max-height: 80vh;
        }
        
        .video-js .vjs-big-play-button {
          font-size: 2.5em;
          line-height: 2.3;
          height: 2.5em;
          width: 2.5em;
          border-radius: 50%;
          background-color: rgba(43, 51, 63, 0.7);
          border: 0.15em solid #fff;
          margin-top: -1.25em;
          margin-left: -1.25em;
        }
        
        .video-js .vjs-control-bar {
          background: linear-gradient(180deg, transparent, rgba(0,0,0,0.7));
        }
        
        .video-js .vjs-progress-control .vjs-progress-holder {
          height: 0.3em;
        }
        
        .video-js .vjs-progress-control .vjs-play-progress {
          background-color: #0ea5e9;
        }
        
        .video-js .vjs-progress-control .vjs-load-progress {
          background: rgba(255, 255, 255, 0.4);
        }

    /* sticky header */
    table thead th {
      position: sticky;
      top: 0;
      z-index: 10;
    }
.subline {
      margin-top: 2px;
      font-size: 12px;
      color: #64748b;
      line-height: 1.35;
    }
    .subline code {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 12px;
    }

    /* toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.92);
      color: white;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 12px 24px -16px rgba(15, 23, 42, 0.55);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
      z-index: 2000;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }


    /* Transgender Pride theme + dark mode (minimal override) */
    :root {
      color-scheme: light dark;
      --tp-blue: #5bcffa;
      --tp-pink: #f5abb9;
      --tp-white: #ffffff;

      --bg: #ffffff;
      --surface: #ffffff;
      --text-strong: #0f172a;
      --text: #1f2937;
      --muted: #475569;
      --muted-2: #64748b;
      --border: rgba(91, 207, 250, 0.28);
      --border-2: rgba(245, 171, 185, 0.28);
      --shadow: rgba(15, 23, 42, 0.18);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1220;
        --surface: #0f172a;
        --text-strong: #f8fafc;
        --text: #e2e8f0;
        --muted: #cbd5e1;
        --muted-2: #94a3b8;
        --border: rgba(91, 207, 250, 0.22);
        --border-2: rgba(245, 171, 185, 0.22);
        --shadow: rgba(0, 0, 0, 0.35);
      }
    }

    html[data-theme="light"] {
      color-scheme: light;
      --bg: #ffffff;
      --surface: #ffffff;
      --text-strong: #0f172a;
      --text: #1f2937;
      --muted: #475569;
      --muted-2: #64748b;
      --border: rgba(91, 207, 250, 0.28);
      --border-2: rgba(245, 171, 185, 0.28);
      --shadow: rgba(15, 23, 42, 0.18);
    }

    html[data-theme="dark"] {
      color-scheme: dark;
      --bg: #0b1220;
      --surface: #0f172a;
      --text-strong: #f8fafc;
      --text: #e2e8f0;
      --muted: #cbd5e1;
      --muted-2: #94a3b8;
      --border: rgba(91, 207, 250, 0.22);
      --border-2: rgba(245, 171, 185, 0.22);
      --shadow: rgba(0, 0, 0, 0.35);
    }

    body {
      background:
        radial-gradient(900px circle at 10% 5%, rgba(91, 207, 250, 0.22), transparent 45%),
        radial-gradient(900px circle at 90% 10%, rgba(245, 171, 185, 0.22), transparent 45%),
        var(--bg);
      color: var(--text);
    }

    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: 0 12px 24px -16px var(--shadow);
    }

    .group-item:hover {
      background-color: rgba(91, 207, 250, 0.10);
      border-color: var(--border);
    }

    .group-item.active {
      background: linear-gradient(90deg, rgba(91, 207, 250, 0.18), rgba(245, 171, 185, 0.14));
      border-color: rgba(91, 207, 250, 0.55);
    }

    .search-box input {
      background: var(--surface);
      border-color: var(--border);
      color: var(--text);
    }

    table thead th {
      background: linear-gradient(90deg, rgba(91, 207, 250, 0.12), rgba(245, 171, 185, 0.10));
      color: var(--muted);
    }

    table tbody tr:hover {
      background-color: rgba(91, 207, 250, 0.06);
    }

    .actions a,
    .actions button {
      color: #2b8cc0;
    }

    .actions a:hover,
    .actions button:hover {
      color: #f07f93;
    }

    .action-button.primary {
      background: linear-gradient(135deg, rgba(91, 207, 250, 0.18) 0%, rgba(245, 171, 185, 0.16) 100%);
      color: var(--text-strong);
      border: 1px solid rgba(91, 207, 250, 0.55);
      box-shadow: 0 4px 12px -8px var(--shadow);
    }

    .action-button.primary:hover {
      background: linear-gradient(135deg, rgba(91, 207, 250, 0.24) 0%, rgba(245, 171, 185, 0.20) 100%);
      box-shadow: 0 6px 16px -10px var(--shadow);
    }

    .action-button.secondary {
      background: var(--surface);
      color: var(--text-strong);
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px -10px var(--shadow);
    }

    .action-button.secondary:hover {
      background: linear-gradient(135deg, rgba(91, 207, 250, 0.10) 0%, rgba(245, 171, 185, 0.08) 100%);
    }

    html[data-theme="dark"] .action-button.secondary {
      background: var(--surface);
    }

    /* make Tailwind slate text colors theme-aware */
    .text-slate-900 { color: var(--text-strong) !important; }
    .text-slate-700 { color: var(--text) !important; }
    .text-slate-600 { color: var(--text) !important; }
    .text-slate-500 { color: var(--muted-2) !important; }
    .text-slate-400 { color: var(--muted-2) !important; }

    .border-slate-200 { border-color: var(--border) !important; }
    .bg-white { background-color: var(--surface) !important; }

    .hover\:bg-slate-50:hover { background-color: rgba(91, 207, 250, 0.06) !important; }

    /* file type cell */
    .type-cell { display: flex; flex-direction: column; gap: 2px; line-height: 1.1; }
    .type-main { font-size: 12px; font-weight: 700; letter-spacing: 0.12em; color: var(--text-strong); }
    .type-sub { font-size: 12px; color: var(--muted-2); }

    .modal-content { background: var(--surface); }
    .modal-title { color: var(--text-strong); }

  </style>
</head>
<body>
  <div class="mx-auto flex min-h-screen max-w-7xl flex-col gap-6 px-6 py-10">
    <header class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <p class="text-xs uppercase tracking-[0.45em] text-slate-500">qq group files</p>
        <h1 class="mt-1 text-3xl font-semibold text-slate-900">{{ title }}</h1>
        <p id="generated-at" class="mt-1 text-sm text-slate-500">数据生成中...</p>
      </div>
      <div class="flex w-full flex-col gap-3 sm:flex-row sm:items-center sm:justify-end">
        <div class="relative search-box w-full max-w-sm">
          <input id="global-search" type="search" placeholder="搜索群、文件或上传者..." autocomplete="off" />
          <svg viewBox="0 0 24 24" aria-hidden="true" class="h-5 w-5">
            <path fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="m21 21-4.35-4.35M17 10.5A6.5 6.5 0 1 1 4 10.5a6.5 6.5 0 0 1 13 0Z"></path>
          </svg>
        </div>
        <button id="search-clear" type="button" class="action-button secondary hidden">清除</button>
        <button id="refresh-btn" type="button" class="action-button primary refresh">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          <span>刷新</span>
        </button>
        <button id="theme-btn" type="button" class="action-button secondary" title="切换浅色/深色（默认跟随系统）">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"></path>
          </svg>
          <span id="theme-label">主题</span>
        </button>
      </div>
    </header>
    <div class="layout">
      <aside class="panel p-4 flex flex-col gap-4">
        <div>
          <h2 class="text-sm font-semibold text-slate-700">群组</h2>
          <p id="group-count" class="text-xs text-slate-400 mt-1"></p>
        </div>
        <ul id="group-list" class="group-list flex-1 overflow-auto"></ul>
        <div id="group-empty" class="hidden text-sm text-slate-400">暂无群组，请先触发同步。</div>

      </aside>
      <section class="panel flex flex-col overflow-hidden">
        <div class="flex flex-col gap-2 border-b border-slate-200 px-6 py-4">
          <nav id="breadcrumbs" class="flex flex-wrap items-center gap-2 text-sm text-slate-500"></nav>
          <div class="flex flex-wrap items-center gap-2">
            <div id="current-summary" class="text-xs text-slate-400"></div>
            <div class="ml-auto flex flex-wrap items-center gap-2">
              <label class="text-xs text-slate-400">排序</label>
              <select id="sort-by" class="rounded-xl border-slate-200 bg-white text-sm py-2 pl-3 pr-8 shadow-sm">
                <option value="relevance">相关度</option>
                <option value="name">名称</option>
                <option value="time">更新时间</option>
                <option value="size">大小</option>
              </select>
              <button id="sort-dir" type="button" class="action-button secondary" style="padding:8px 12px; border-radius:12px;">升序</button>
            </div>
          </div>
        </div>
        <div class="flex-1 overflow-auto">
          <table>
            <thead>
              <tr>
                <th class="pl-6">名称</th>
                <th class="mobile-hide uploader-column">上传者</th>
                <th>类型</th>
                <th class="mobile-hide">大小</th>
                <th class="mobile-hide">更新时间</th>
                <th class="pr-6">操作</th>
              </tr>
            </thead>
            <tbody id="explorer-rows"></tbody>
          </table>
          <div id="explorer-empty" class="px-6 py-20 text-center text-sm text-slate-400 hidden">这里还没有文件。</div>
        </div>
      </section>
    </div>
  </div>
  
  <!-- 预览不可用Modal -->
  <div id="preview-unavailable-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">无法预览</h3>
        <button id="modal-close" type="button" class="modal-close-btn">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-icon">
          <svg class="h-12 w-12 text-slate-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m6.75 12l-3-3m0 0l-3 3m3-3v6m-1.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></path>
          </svg>
        </div>
        <div class="modal-text">
          <p class="modal-message">此文件类型不支持在线预览</p>
          <p id="modal-filename" class="modal-filename"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button id="modal-cancel" type="button" class="modal-btn modal-btn-secondary">取消</button>
        <a id="modal-download" href="#" class="modal-btn modal-btn-primary" download>
          <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75v6.75m0 0l-3-3m3 3l3-3m-8.25-6a4.5 4.5 0 00-1.08 8.95c.813.031 1.626.094 2.44.094 1.082 0 2.135-.125 3.148-.35A4.5 4.5 0 0018 9.75v-.7V9A6 6 0 006 9v.75a4.5 4.5 0 001.25 8.95z"></path>
          </svg>
          下载文件
        </a>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js" async></script>
  <script>
    // 动态设置页面标题
    document.title = {{ title|tojson }};
    
    const DASHBOARD_DATA_FILE = {{ data_file_name|tojson }};
    const DASHBOARD_BASE_URL = {{ base_url|tojson }};
    const CONFIG_GROUPS = {{ config_groups_json|safe }};
    const basePrefix = (!DASHBOARD_BASE_URL || DASHBOARD_BASE_URL === ".") ? "" : DASHBOARD_BASE_URL.replace(/\/+$/, "");
    const els = {
        search: document.getElementById("global-search"),
        searchClear: document.getElementById("search-clear"),
        refresh: document.getElementById("refresh-btn"),
        themeBtn: document.getElementById("theme-btn"),
        themeLabel: document.getElementById("theme-label"),
        generatedAt: document.getElementById("generated-at"),
        groupList: document.getElementById("group-list"),
        groupEmpty: document.getElementById("group-empty"),
        groupCount: document.getElementById("group-count"),
        breadcrumbs: document.getElementById("breadcrumbs"),
        currentSummary: document.getElementById("current-summary"),
        explorerRows: document.getElementById("explorer-rows"),
        explorerEmpty: document.getElementById("explorer-empty"),
        modal: document.getElementById("preview-unavailable-modal"),
        modalClose: document.getElementById("modal-close"),
        modalCancel: document.getElementById("modal-cancel"),
        modalFilename: document.getElementById("modal-filename"),
        modalDownload: document.getElementById("modal-download"),
        sortBy: document.getElementById("sort-by"),
        sortDir: document.getElementById("sort-dir"),
        toast: document.getElementById("toast"),
      };
    const state = {
       groups: [],
       fuse: null,
       activeGroupId: null,
       activePath: "",
       loading: false,
       searchMode: false,
       searchResults: [],
       sortBy: "name",
       sortDir: "asc",
       theme: "",
       sortByBeforeSearch: null,
     };
    const ICONS = {
      folder: "<svg class=\"h-5 w-5 text-sky-500\" fill=\"currentColor\" viewBox=\"0 0 20 20\" aria-hidden=\"true\"><path d=\"M2.75 4.5A1.75 1.75 0 0 1 4.5 2.75h3.086c.464 0 .909.184 1.237.512l1.152 1.152c.328.328.773.512 1.237.512H15.5A1.75 1.75 0 0 1 17.25 6.75v8.5A1.75 1.75 0 0 1 15.5 17H4.5A1.75 1.75 0 0 1 2.75 15.25V4.5Z\"></path></svg>",
      file: "<svg class=\"h-5 w-5 text-slate-400\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" viewBox=\"0 0 24 24\" aria-hidden=\"true\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M19.5 12.75v5.25a1.5 1.5 0 0 1-1.5 1.5h-12a1.5 1.5 0 0 1-1.5-1.5v-12a1.5 1.5 0 0 1 1.5-1.5h6L19.5 9v3.75Z\"></path><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M13.5 3v4.125a1.125 1.125 0 0 0 1.125 1.125H18\"></path></svg>",
    };
    const UNSAFE_PATTERN = /[<>:"|?*\\/]/g;
    const IMAGE_EXTS = ["jpg","jpeg","png","gif","webp","bmp","svg","heic","avif","jfif"];
    const VIDEO_EXTS = ["webm","mov","mkv","avi","wmv","flv","3gp"];
    const AUDIO_EXTS = ["mp3","wav","flac","aac","oga","m4a","wma","opus"];
    const MEDIA_EXTS = ["mp4","m4v","ogg"]; // 可能包含视频或音频的格式
    const TEXT_EXTS = ["txt","md","json","log","csv","yml","yaml","ini","cfg","conf","go","py","js","ts","rs","java","cs","cpp","c","hpp","h","sql"];

    function sanitize(value) {
      if (!value) {
        return "";
      }
      return String(value).replace(UNSAFE_PATTERN, "_");
    }

    function escapeHTML(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function encodePath(parts) {
      return parts.filter(Boolean).map((segment) => encodeURIComponent(segment)).join("/");
    }

    function formatSize(bytes) {
      if (!Number.isFinite(bytes) || bytes < 0) {
        return "-";
      }
      const units = ["B", "KB", "MB", "GB", "TB"];
      let value = bytes;
      let idx = 0;
      while (value >= 1024 && idx < units.length - 1) {
        value /= 1024;
        idx += 1;
      }
      const fractionDigits = idx === 0 ? 0 : (value < 10 ? 1 : 0);
      return value.toFixed(fractionDigits) + " " + units[idx];
    }

    function getExt(name) {
      const s = String(name || "");
      const idx = s.lastIndexOf(".");
      if (idx <= 0 || idx === s.length - 1) return "";
      return s.slice(idx + 1).toLowerCase();
    }

    function typeInfo(kind, fileName) {
      const ext = getExt(fileName);
      const upper = ext ? ext.toUpperCase() : "";
      const k = String(kind || "").toLowerCase();
      if (k === "pdf") return { main: "PDF", sub: "文档" };
      if (k === "image") return { main: upper || "IMG", sub: "图片" };
      if (k === "video") return { main: upper || "VID", sub: "视频" };
      if (k === "audio") return { main: upper || "AUD", sub: "音频" };
      if (k === "text") return { main: upper || "TXT", sub: "文本" };
      if (k === "folder") return { main: "DIR", sub: "文件夹" };
      return { main: upper || "FILE", sub: "文件" };
    }

    function renderTypeCell(info) {
      const main = escapeHTML((info && info.main) ? info.main : "FILE");
      const sub = escapeHTML((info && info.sub) ? info.sub : "文件");
      return '<div class="type-cell"><div class="type-main">' + main + '</div><div class="type-sub">' + sub + '</div></div>';
    }

    function typeToLabel(info) {
      if (!info) return "文件";
      const main = (info.main && info.main !== "FILE") ? info.main : "";
      return info.sub + (main ? (" " + main) : "");
    }
function pad(num) {
      return num < 10 ? "0" + num : String(num);
    }

    function formatDateTime(ts) {
      if (!ts) {
        return "无记录";
      }
      const date = new Date(Number(ts) * 1000);
      if (Number.isNaN(date.getTime())) {
        return "无记录";
      }
      return (
        date.getFullYear() + "-" +
        pad(date.getMonth() + 1) + "-" +
        pad(date.getDate()) + " " +
        pad(date.getHours()) + ":" +
        pad(date.getMinutes())
      );
    }

    function formatTimeAgo(ts) {
      if (!ts) {
        return "";
      }
      const now = Date.now();
      const diff = Math.max(0, now - Number(ts) * 1000);
      const seconds = Math.floor(diff / 1000);
      if (seconds < 60) {
        return "刚刚";
      }
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) {
        return minutes + " 分钟前";
      }
      const hours = Math.floor(minutes / 60);
      if (hours < 24) {
        return hours + " 小时前";
      }
      const days = Math.floor(hours / 24);
      if (days < 7) {
        return days + " 天前";
      }
      const weeks = Math.floor(days / 7);
      if (weeks < 5) {
        return weeks + " 周前";
      }
      const months = Math.floor(days / 30);
      if (months < 12) {
        return months + " 个月前";
      }
      const years = Math.floor(days / 365);
      return years + " 年前";
    }

    function readPref(key, fallback) {
      try {
        const v = localStorage.getItem(key);
        if (v === null || v === undefined) {
          return fallback;
        }
        return v;
      } catch {
        return fallback;
      }
    }

    function writePref(key, value) {
      try {
        localStorage.setItem(key, String(value));
      } catch {
        // ignore
      }
    }

    function showToast(message) {
      if (!els.toast) {
        return;
      }
      els.toast.textContent = message;
      els.toast.classList.add("show");
      window.clearTimeout(showToast._t);
      showToast._t = window.setTimeout(() => {
        els.toast.classList.remove("show");
      }, 1600);
    }

    function getExt(name) {
      const parts = String(name || "").toLowerCase().split(".");
      if (parts.length <= 1) {
        return "";
      }
      return parts.pop() || "";
    }

    function sortFiles(files) {
      const key = state.sortBy || "name";
      const dir = state.sortDir === "desc" ? -1 : 1;
      const list = (files || []).slice();
      if (key === "relevance") {
        // 非搜索模式下，相关度排序无意义，回退到名称排序
        if (!state.searchMode) {
          list.sort((a, b) => a.fileName.localeCompare(b.fileName, "zh-Hans") * dir);
          return list;
        }
        return list;
      }
      const byName = (a, b) => a.fileName.localeCompare(b.fileName, "zh-Hans") * dir;
      if (key === "name") {
        list.sort(byName);
        return list;
      }
      if (key === "size") {
        list.sort((a, b) => ((a.size || 0) - (b.size || 0)) * dir || byName(a, b));
        return list;
      }
      if (key === "time") {
        list.sort((a, b) => ((a.modify_time || 0) - (b.modify_time || 0)) * dir || byName(a, b));
        return list;
      }
      list.sort(byName);
      return list;
    }


    function detectKind(fileName) {
      const ext = (fileName || "").toLowerCase().split(".").pop();
      if (!ext) {
        return "download";
      }
      if (IMAGE_EXTS.includes(ext)) {
        return "image";
      }
      if (VIDEO_EXTS.includes(ext)) {
        return "video";
      }
      if (MEDIA_EXTS.includes(ext)) {
        // MP4、M4V、OGG等格式默认作为视频处理
        // 用户可以通过播放器界面判断是否包含视频内容
        return "video";
      }
      if (AUDIO_EXTS.includes(ext)) {
        return "audio";
      }
      if (ext === "pdf") {
        return "pdf";
      }
      if (ext === "html" || ext === "htm") {
        return "iframe";
      }
      if (TEXT_EXTS.includes(ext)) {
        return "text";
      }
      return "download";
    }

    function buildPaths(groupRoot, file) {
      const rawFolder = (file.folder_path || "").replace(/\\/g, "/").replace(/^\/+|\/+$/g, "");
      const folderSegments = rawFolder ? rawFolder.split("/").filter(Boolean) : [];
      const sanitizedFileName = sanitize(file.file_name || "未命名文件");
      const relativeSegments = folderSegments.concat(sanitizedFileName);
      const relativePath = relativeSegments.join("/");
      const withGroup = groupRoot ? [groupRoot].concat(relativeSegments).join("/") : relativePath;
      return {
        folderSegments,
        relativePath,
        withGroup,
      };
    }

    function makeURL(relative) {
      const parts = relative.split("/");
      const encoded = encodePath(parts);
      if (!basePrefix) {
        return encoded;
      }
      return basePrefix + "/" + encoded;
    }

    function decorateFile(group, file) {
      const paths = buildPaths(group.rootDir, file);
      return {
        fileName: file.file_name || "未命名文件",
        size: Number(file.file_size || 0),
        modify_time: Number(file.modify_time || file.upload_time || 0),
        upload_time: Number(file.upload_time || 0),
        previewKind: detectKind(file.file_name),
        uploader: file.uploader_name || file.uploader || "",
        group: { id: group.id, alias: group.alias, description: group.description || "" },
        folderSegments: paths.folderSegments,
        folderPath: paths.folderSegments.join("/"),
        downloadURL: makeURL(paths.withGroup),
        relativePath: paths.relativePath,
        fullPath: paths.relativePath,
        raw: file,
      };
    }

    function buildDirectoryIndex(files) {
      const store = new Map();
      const ensure = (path) => {
        if (!store.has(path)) {
          store.set(path, { folders: new Map(), files: [] });
        }
        return store.get(path);
      };
      ensure("");
      files.forEach((file) => {
        const segments = file.folderSegments || [];
        let currentPath = "";
        segments.forEach((segment) => {
          const parent = ensure(currentPath);
          const childPath = currentPath ? currentPath + "/" + segment : segment;
          if (!parent.folders.has(childPath)) {
            parent.folders.set(childPath, { name: segment, fullPath: childPath });
          }
          currentPath = childPath;
          ensure(currentPath);
        });
        const bucket = ensure(currentPath);
        bucket.files.push(file);
      });
      const result = {};
      store.forEach((entry, path) => {
        const folders = Array.from(entry.folders.values()).sort((a, b) => a.name.localeCompare(b.name, "zh-Hans"));
        const filesAtPath = entry.files.slice().sort((a, b) => a.fileName.localeCompare(b.fileName, "zh-Hans"));
        result[path] = { folders, files: filesAtPath };
      });
      if (!result[""]) {
        result[""] = { folders: [], files: [] };
      }
      return result;
    }
    function decorateGroup(group, entry) {
      const status = entry ? entry.status || null : null;
      const files = status && Array.isArray(status.files) ? status.files.map((file) => decorateFile(group, file)) : [];
      const lastUpdate = status && status.last_update ? Number(status.last_update) : 0;
      return {
        id: group.id,
        alias: group.alias || group.id,
        description: group.description || "",
        rootDir: group.rootDir,
        statusPath: group.statusPath,
        status,
        files,
        directories: buildDirectoryIndex(files),
        totalFiles: status && typeof status.total_files === "number" ? status.total_files : files.length,
        totalFolders: status && typeof status.total_folders === "number" ? status.total_folders : 0,
        lastUpdate,
      };
    }

    function normalizeConfigs(groups) {
      return (groups || []).map((item) => ({
        id: item.id,
        alias: item.alias || item.id,
        description: item.description || "",
        rootDir: item.rootDir,
        statusPath: item.statusPath,
      }));
    }

    function extractGroups(json) {
      if (!json || !Array.isArray(json.groups)) {
        return [];
      }
      return json.groups.map((entry) => ({
        id: entry.id || "",
        rootDir: entry.rootDir || "",
        statusPath: entry.statusPath || "",
        status: entry.status || null,
      }));
    }

    function mergeGroups(configs, dataEntries) {
      const byId = new Map();
      (dataEntries || []).forEach((entry) => {
        if (entry && entry.id) {
          byId.set(entry.id, entry);
        }
      });
      const byStatus = new Map();
      (dataEntries || []).forEach((entry) => {
        if (entry && entry.statusPath) {
          byStatus.set(entry.statusPath, entry);
        }
      });
      const result = [];
      (configs || []).forEach((cfg) => {
        if (!cfg || !cfg.id) {
          return;
        }
        const entry = byId.get(cfg.id) || byStatus.get(cfg.statusPath);
        if (entry) {
          entry.__used = true;
        }
        result.push(decorateGroup(cfg, entry));
      });
      (dataEntries || []).forEach((entry) => {
        if (!entry || entry.__used) {
          return;
        }
        const id = entry.id || entry.rootDir || entry.statusPath;
        if (!id) {
          return;
        }
        const fallback = {
          id: id,
          alias: id,
          description: "",
          rootDir: entry.rootDir || entry.statusPath || "",
          statusPath: entry.statusPath || "",
        };
        result.push(decorateGroup(fallback, entry));
      });
      result.sort((a, b) => {
        if (a.lastUpdate === b.lastUpdate) {
          return a.alias.localeCompare(b.alias, "zh-Hans");
        }
        return b.lastUpdate - a.lastUpdate;
      });
      return result;
    }

    function buildSearchIndex(groups) {
      const files = [];
      groups.forEach((group) => {
        group.files.forEach((file) => files.push(file));
      });
      if (!files.length || typeof Fuse === "undefined") {
        state.fuse = null;
        return;
      }
      state.fuse = new Fuse(files, {
        keys: [
          { name: "fileName", weight: 0.5 },
          { name: "group.alias", weight: 0.2 },
          { name: "group.id", weight: 0.2 },
          { name: "uploader", weight: 0.1 },
          { name: "relativePath", weight: 0.3 },
        ],
        threshold: 0.35,
        ignoreLocation: true,
      });
    }

    function setLoading(loading) {
      state.loading = loading;
      els.refresh.disabled = loading;
      els.refresh.textContent = loading ? "刷新中..." : "刷新列表";
    }

    function getActiveGroup() {
      if (!state.activeGroupId) {
        return null;
      }
      return state.groups.find((group) => group.id === state.activeGroupId) || null;
    }

    function setActiveGroup(groupId) {
      state.activeGroupId = groupId;
      state.activePath = "";
      renderGroupList();
      renderExplorer();
    }

    function setActivePath(path) {
      const group = getActiveGroup();
      if (!group) {
        return;
      }
      const normalized = path || "";
      if (!group.directories[normalized]) {
        state.activePath = "";
      } else {
        state.activePath = normalized;
      }
      renderExplorer();
    }

    function renderGroupList() {
      els.groupList.innerHTML = "";
      if (!state.groups.length) {
        els.groupEmpty.classList.remove("hidden");
        els.groupCount.textContent = "";
        return;
      }
      els.groupEmpty.classList.add("hidden");
      els.groupCount.textContent = "共 " + state.groups.length + " 个";
      state.groups.forEach((group) => {
        const li = document.createElement("li");
        li.className = "group-item" + (group.id === state.activeGroupId ? " active" : "");
        const alias = document.createElement("span");
        alias.className = "group-item__alias";
        alias.textContent = group.alias || group.id;
        const meta = document.createElement("div");
        meta.className = "group-item__meta";
        const pieces = [];
        // pieces.push(group.id); // 注:不再插入群号
        if (group.totalFiles) {
          pieces.push("文件 " + group.totalFiles);
        }
        if (group.lastUpdate) {
          pieces.push(formatTimeAgo(group.lastUpdate));
        }
        meta.textContent = pieces.join(" · ");
        li.appendChild(alias);
        li.appendChild(meta);
        li.addEventListener("click", () => setActiveGroup(group.id));
        els.groupList.appendChild(li);
      });
    }

    function renderBreadcrumbs(group) {
      els.breadcrumbs.innerHTML = "";
      const segments = state.activePath ? state.activePath.split("/").filter(Boolean) : [];
      const appendCrumb = (label, nextPath) => {
        const button = document.createElement("button");
        button.type = "button";
        button.textContent = label;
        button.className = nextPath === state.activePath ? "text-slate-900 font-medium" : "text-slate-500 hover:text-slate-900";
        button.addEventListener("click", () => setActivePath(nextPath));
        els.breadcrumbs.appendChild(button);
      };
      appendCrumb("全部文件", "");
      let current = "";
      segments.forEach((segment) => {
        const separator = document.createElement("span");
        separator.textContent = ">";
        els.breadcrumbs.appendChild(separator);
        current = current ? current + "/" + segment : segment;
        appendCrumb(segment, current);
      });
      if (group && group.description) {
        const separator = document.createElement("span");
        separator.textContent = "·";
        separator.className = "text-slate-400";
        els.breadcrumbs.appendChild(separator);
        const desc = document.createElement("span");
        desc.textContent = group.description;
        desc.className = "text-slate-400";
        els.breadcrumbs.appendChild(desc);
      }
    }

    function renderExplorer() {
      els.explorerRows.innerHTML = "";
      els.explorerEmpty.classList.add("hidden");
      
      // 如果是搜索模式，显示搜索结果
      if (state.searchMode) {
        renderBreadcrumbs(null);
        els.currentSummary.textContent = "搜索结果 " + state.searchResults.length + " 个文件";
        
        if (!state.searchResults.length) {
          els.explorerEmpty.classList.remove("hidden");
          els.explorerEmpty.textContent = "没有匹配的文件，换个关键词试试。";
          return;
        }
        
        const searchItems = state.searchResults.slice(0, 50).map((x) => x.item);
        const ordered = (state.sortBy && state.sortBy !== "relevance") ? sortFiles(searchItems) : searchItems;
        ordered.forEach((item) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-50";

          const nameTd = document.createElement("td");
          nameTd.className = "py-3 pl-6 pr-4 text-slate-700 name-cell";
          const nameWrap = document.createElement("div");
          nameWrap.className = "flex items-center gap-3";

          // 添加可点击的图标用于预览
          const iconSpan = document.createElement("span");
          iconSpan.innerHTML = ICONS.file;
          iconSpan.className = "cursor-pointer hover:text-sky-600 flex-shrink-0";
          iconSpan.title = "点击预览";
          iconSpan.addEventListener("click", (event) => {
            event.stopPropagation();
            openPreview(item);
          });
          nameWrap.appendChild(iconSpan);

          const text = document.createElement("span");
          text.className = "truncate";
          text.textContent = item.fileName;
          text.title = item.fileName; // 添加悬停显示完整文件名
          nameWrap.appendChild(text);
          nameTd.appendChild(nameWrap);

          const sub = document.createElement("div");
          sub.className = "subline";
          const groupLabel = (item.group && (item.group.alias || item.group.id)) ? (item.group.alias || item.group.id) : "";
          const folder = item.folderPath ? item.folderPath : "";
          sub.innerHTML = "<code>" + escapeHTML(groupLabel) + "</code>" + (folder ? (" / " + escapeHTML(folder)) : "");
          nameTd.appendChild(sub);

          const uploaderTd = document.createElement("td");
          uploaderTd.className = "px-4 py-3 text-slate-600 mobile-hide uploader-column";
          uploaderTd.textContent = item.uploader || "-";
          const typeTd = document.createElement("td");
          typeTd.className = "px-4 py-3 text-slate-500";
          const typeMeta = typeInfo(item.previewKind, item.fileName);
          const displayType = typeToLabel(typeMeta);
          typeTd.innerHTML = renderTypeCell(typeMeta);

          const sizeTd = document.createElement("td");
          sizeTd.className = "px-4 py-3 text-slate-600 mobile-hide";
          const sizeText = formatSize(item.size);
          sizeTd.textContent = sizeText;

          const timeTd = document.createElement("td");
          timeTd.className = "px-4 py-3 text-slate-500 mobile-hide";
          const timeText = formatDateTime(item.modify_time || item.upload_time);
          timeTd.textContent = timeText;

          const metaInfo = document.createElement("div");
          metaInfo.className = "meta-info";
          if (displayType) {
            const typeSpan = document.createElement("span");
            typeSpan.textContent = "类型 " + displayType;
            metaInfo.appendChild(typeSpan);
          }
          if (sizeText && sizeText !== "-") {
            const sizeSpan = document.createElement("span");
            sizeSpan.textContent = "大小 " + sizeText;
            metaInfo.appendChild(sizeSpan);
          }
          if (timeText && timeText !== "无记录") {
            const timeSpan = document.createElement("span");
            timeSpan.textContent = "时间 " + timeText;
            metaInfo.appendChild(timeSpan);
          }
          if (item.uploader) {
            const uploaderSpan = document.createElement("span");
            uploaderSpan.textContent = "上传者 " + item.uploader;
            metaInfo.appendChild(uploaderSpan);
          }
          const metaTd = document.createElement("td");
          metaTd.className = "meta-info-cell";
          metaTd.appendChild(metaInfo);

          const actionTd = document.createElement("td");
          actionTd.className = "py-3 pr-6 actions action-cell";

          const previewBtn = document.createElement("button");
          previewBtn.type = "button";
          previewBtn.className = "text-sm text-slate-500 hover:text-slate-800 action-control download-link";
          previewBtn.textContent = "预览";
          previewBtn.addEventListener("click", (event) => {
            event.stopPropagation();
            openPreview(item);
          });
          actionTd.appendChild(previewBtn);

          if (item.downloadURL) {
            const downloadLink = document.createElement("a");
            downloadLink.href = item.downloadURL;
            downloadLink.className = "text-sm text-slate-500 hover:text-slate-800 action-control download-link";
            downloadLink.textContent = "下载";
            downloadLink.setAttribute("download", sanitize(item.fileName) || "download");
            downloadLink.addEventListener("click", (event) => {
              event.stopPropagation();
            });
            actionTd.appendChild(downloadLink);

            const copyBtn = document.createElement("button");
            copyBtn.type = "button";
            copyBtn.className = "text-sm text-slate-500 hover:text-slate-800 action-control download-link";
            copyBtn.textContent = "复制链接";
            copyBtn.addEventListener("click", async (event) => {
              event.stopPropagation();
              try {
                await navigator.clipboard.writeText(item.downloadURL);
                showToast("已复制下载链接");
              } catch {
                window.prompt("复制下载链接", item.downloadURL);
              }
            });
            actionTd.appendChild(copyBtn);
          }

          // 跳转按钮放在最后
          const jumpBtn = document.createElement("button");
          jumpBtn.type = "button";
          jumpBtn.className = "text-sm text-green-600 hover:text-green-800 action-control jump-link";
          jumpBtn.textContent = "跳转";
          jumpBtn.addEventListener("click", (event) => {
            event.stopPropagation();
            // 清除搜索，跳转到文件所在位置
            clearSearch();
            setActiveGroup(item.group.id);
            setActivePath(item.folderPath || "");
            // 延迟执行滚动和高亮，等待页面渲染完成
            setTimeout(() => {
              scrollToAndHighlightFile(item.fileName);
            }, 100);
          });
          actionTd.appendChild(jumpBtn);

          tr.append(nameTd, uploaderTd, metaTd, typeTd, sizeTd, timeTd, actionTd);
          els.explorerRows.appendChild(tr);
        });
        return;
      }
      
      // 正常模式：显示目录内容
      const group = getActiveGroup();
      if (!group) {
        els.currentSummary.textContent = "请选择左侧群组";
        renderBreadcrumbs(null);
        els.explorerEmpty.classList.remove("hidden");
        return;
      }
      renderBreadcrumbs(group);
      const directories = group.directories || {};
      const entry = directories[state.activePath] || { folders: [], files: [] };
      els.currentSummary.textContent = "文件夹 " + entry.folders.length + " · 文件 " + entry.files.length;
      if (!entry.folders.length && !entry.files.length) {
        els.explorerEmpty.classList.remove("hidden");
        return;
      }
      entry.folders.forEach((folder) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-50 cursor-pointer";
        tr.addEventListener("click", () => setActivePath(folder.fullPath));
        const nameTd = document.createElement("td");
        nameTd.className = "py-3 pl-6 pr-4 text-slate-700 name-cell";
        const nameWrap = document.createElement("div");
        nameWrap.className = "flex items-center gap-3";
        nameWrap.innerHTML = ICONS.folder;
        const text = document.createElement("span");
        text.className = "font-medium";
        text.textContent = folder.name || "(未命名文件夹)";
        // 添加完整路径的悬停提示
        text.title = folder.fullPath || folder.name;
        nameWrap.appendChild(text);
        nameTd.appendChild(nameWrap);

        const folderMeta = document.createElement("div");
        folderMeta.className = "meta-info";
        const folderTypeSpan = document.createElement("span");
        folderTypeSpan.textContent = "类型 文件夹";
        folderMeta.appendChild(folderTypeSpan);
        const folderMetaTd = document.createElement("td");
        folderMetaTd.className = "meta-info-cell";
        folderMetaTd.appendChild(folderMeta);

        const uploaderTd = document.createElement("td");
        uploaderTd.className = "px-4 py-3 text-slate-400 mobile-hide uploader-column";
        uploaderTd.textContent = "-";

        const typeTd = document.createElement("td");
        typeTd.className = "px-4 py-3 text-slate-500";
        typeTd.textContent = "文件夹";
        const sizeTd = document.createElement("td");
        sizeTd.className = "px-4 py-3 text-slate-400 mobile-hide";
        sizeTd.textContent = "-";
        const timeTd = document.createElement("td");
        timeTd.className = "px-4 py-3 text-slate-500 mobile-hide";
        timeTd.textContent = "";
        const actionTd = document.createElement("td");
        actionTd.className = "py-3 pr-6 actions action-cell";
        const openBtn = document.createElement("button");
        openBtn.type = "button";
        openBtn.className = "text-sm text-slate-500 hover:text-slate-800 action-control open-link";
        openBtn.textContent = "进入";
        openBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          setActivePath(folder.fullPath);
        });
        actionTd.appendChild(openBtn);
        tr.append(nameTd, uploaderTd, folderMetaTd, typeTd, sizeTd, timeTd, actionTd);
        els.explorerRows.appendChild(tr);
      });
      const filesOrdered = sortFiles(entry.files);
      filesOrdered.forEach((file) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-50";
        const nameTd = document.createElement("td");
        nameTd.className = "py-3 pl-6 pr-4 text-slate-700 name-cell";
        const nameWrap = document.createElement("div");
        nameWrap.className = "flex items-center gap-3";
        
        // 添加可点击的图标用于预览
        const iconSpan = document.createElement("span");
        iconSpan.innerHTML = ICONS.file;
        iconSpan.className = "cursor-pointer hover:text-sky-600 flex-shrink-0";
        iconSpan.title = "点击预览";
        iconSpan.addEventListener("click", (event) => {
          event.stopPropagation();
          openPreview(file);
        });
        nameWrap.appendChild(iconSpan);
        
        const text = document.createElement("span");
        text.className = "truncate";
        text.textContent = file.fileName;
        text.style.cursor = "pointer";
        text.addEventListener("click", (event) => {
          event.stopPropagation();
          openPreview(file);
        });
        // 添加完整路径的悬停提示
        text.title = file.fullPath || file.fileName;
        nameWrap.appendChild(text);
        nameTd.appendChild(nameWrap);

        const uploaderTd = document.createElement("td");
        uploaderTd.className = "px-4 py-3 text-slate-600 mobile-hide uploader-column";
        uploaderTd.textContent = file.uploader || "-";
        const typeTd = document.createElement("td");
        typeTd.className = "px-4 py-3 text-slate-500";
        const typeMeta = typeInfo(file.previewKind, file.fileName);
        const displayType = typeToLabel(typeMeta);
        typeTd.innerHTML = renderTypeCell(typeMeta);
        const sizeTd = document.createElement("td");
        sizeTd.className = "px-4 py-3 text-slate-600 mobile-hide";
        const sizeText = formatSize(file.size);
        sizeTd.textContent = sizeText;
        const timeTd = document.createElement("td");
        timeTd.className = "px-4 py-3 text-slate-500 mobile-hide";
        const timeText = formatDateTime(file.modify_time || file.upload_time);
        timeTd.textContent = timeText;

        const metaInfo = document.createElement("div");
        metaInfo.className = "meta-info";
        if (displayType) {
          const typeSpan = document.createElement("span");
          typeSpan.textContent = "类型 " + displayType;
          metaInfo.appendChild(typeSpan);
        }
        if (sizeText && sizeText !== "-") {
          const sizeSpan = document.createElement("span");
          sizeSpan.textContent = "大小 " + sizeText;
          metaInfo.appendChild(sizeSpan);
        }
        if (timeText && timeText !== "无记录") {
          const timeSpan = document.createElement("span");
          timeSpan.textContent = "时间 " + timeText;
          metaInfo.appendChild(timeSpan);
        }
        if (file.uploader) {
          const uploaderSpan = document.createElement("span");
          uploaderSpan.textContent = "上传者 " + file.uploader;
          metaInfo.appendChild(uploaderSpan);
        }
        const metaTd = document.createElement("td");
        metaTd.className = "meta-info-cell";
        metaTd.appendChild(metaInfo);

        const actionTd = document.createElement("td");
        actionTd.className = "py-3 pr-6 actions action-cell";
        const previewBtn = document.createElement("button");
        previewBtn.type = "button";
        previewBtn.className = "text-sm text-slate-500 hover:text-slate-800 action-control download-link";
        previewBtn.textContent = "预览";
        previewBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          openPreview(file);
        });
        actionTd.appendChild(previewBtn);
        if (file.downloadURL) {
          const downloadLink = document.createElement("a");
          downloadLink.href = file.downloadURL;
          downloadLink.className = "text-sm text-slate-500 hover:text-slate-800 action-control download-link";
          downloadLink.textContent = "下载";
          downloadLink.setAttribute("download", sanitize(file.fileName) || "download");
          downloadLink.addEventListener("click", (event) => {
            event.stopPropagation();
          });
          actionTd.appendChild(downloadLink);

          const copyBtn = document.createElement("button");
          copyBtn.type = "button";
          copyBtn.className = "text-sm text-slate-500 hover:text-slate-800 action-control download-link";
          copyBtn.textContent = "复制链接";
          copyBtn.addEventListener("click", async (event) => {
            event.stopPropagation();
            try {
              await navigator.clipboard.writeText(file.downloadURL);
              showToast("已复制下载链接");
            } catch {
              window.prompt("复制下载链接", file.downloadURL);
            }
          });
          actionTd.appendChild(copyBtn);
        }
        tr.append(nameTd, uploaderTd, metaTd, typeTd, sizeTd, timeTd, actionTd);
        els.explorerRows.appendChild(tr);
      });
    }
    function handleSearch() {
      const keyword = els.search.value.trim();
      if (!keyword) {
        els.searchClear.classList.add("hidden");
        // 退出搜索时恢复排序偏好
        if (state.sortByBeforeSearch) {
          state.sortBy = state.sortByBeforeSearch;
          state.sortByBeforeSearch = null;
          if (els.sortBy) {
            els.sortBy.value = state.sortBy;
          }
        }
        state.searchMode = false;
        state.searchResults = [];
        renderExplorer();
        return;
      }

      // 第一次进入搜索时，默认用相关度排序（不写入本地偏好）
      if (!state.searchMode && !state.sortByBeforeSearch) {
        state.sortByBeforeSearch = state.sortBy;
        state.sortBy = "relevance";
        if (els.sortBy) {
          els.sortBy.value = state.sortBy;
        }
      }

      els.searchClear.classList.remove("hidden");
      if (!state.fuse) {
        state.searchMode = true;
        state.searchResults = [];
        renderExplorer();
        return;
      }
      const matches = state.fuse.search(keyword, { limit: 50 });
      state.searchMode = true;
      state.searchResults = matches;
      renderExplorer();
    }

    function clearSearch() {
      els.search.value = "";
      els.search.focus();
      els.searchClear.classList.add("hidden");
      // 清除搜索时恢复排序偏好
      if (state.sortByBeforeSearch) {
        state.sortBy = state.sortByBeforeSearch;
        state.sortByBeforeSearch = null;
        if (els.sortBy) {
          els.sortBy.value = state.sortBy;
        }
      }
      state.searchMode = false;
      state.searchResults = [];
      renderExplorer();
    }

    function openPreview(file) {
      if (!file || !file.downloadURL) {
        return;
      }
      const caption = (file.group.alias || file.group.id) + " / " + file.fileName;
      
      // 对于不支持预览的文件，显示modal
      if (file.previewKind === "download") {
        showPreviewUnavailableModal(file);
        return;
      }
      
      if (!window.Fancybox) {
        window.open(file.downloadURL, "_blank");
        return;
      }
      if (file.previewKind === "image") {
        window.Fancybox.show([{ src: file.downloadURL, type: "image", caption: escapeHTML(caption) }]);
        return;
      }
      if (file.previewKind === "video") {
        const fileExt = (file.fileName || "").toLowerCase().split(".").pop();
        const mimeType = {
          'mp4': 'video/mp4',
          'webm': 'video/webm',
          'ogg': 'video/ogg',
          'mov': 'video/quicktime',
          'm4v': 'video/mp4',
          'mkv': 'video/x-matroska'
        }[fileExt] || 'video/mp4';
        
        const videoId = 'video-player-' + Date.now();
        const html = '<div class="w-[min(50rem,90vw)]">' +
          '<video id="' + videoId + '" class="video-js vjs-default-skin" controls preload="auto" width="800" height="450" data-setup="{}">' +
            '<source src="' + file.downloadURL + '" type="' + mimeType + '">' +
            '<p class="vjs-no-js">要查看此视频，请启用JavaScript，并考虑升级到支持<a href="https://videojs.com/html5-video-support/" target="_blank">HTML5视频</a>的Web浏览器。</p>' +
          '</video>' +
        '</div>';
        
        window.Fancybox.show([{ 
          src: html, 
          type: "html", 
          caption: escapeHTML(caption),
          on: {
            reveal: function() {
              // 初始化Video.js播放器
              if (window.videojs) {
                setTimeout(() => {
                  const player = window.videojs(videoId, {
                    fluid: true,
                    responsive: true,
                    playbackRates: [0.5, 1, 1.25, 1.5, 2],
                    controls: true,
                    preload: 'metadata'
                  });
                  
                  player.ready(() => {
                    player.play().catch(e => {
                      console.log('自动播放被阻止:', e);
                    });
                  });
                }, 100);
              }
            },
            destroy: function() {
              // 清理Video.js播放器
              if (window.videojs && window.videojs.getPlayer) {
                try {
                  const player = window.videojs.getPlayer(videoId);
                  if (player) {
                    player.dispose();
                  }
                } catch (e) {
                  console.log('清理播放器时出错:', e);
                }
              }
            }
          }
        }]);
        return;
      }
      if (file.previewKind === "audio") {
        const html = '<div class="w-[min(28rem,90vw)]"><audio controls autoplay class="w-full"><source src="' + file.downloadURL + '"></audio></div>';
        window.Fancybox.show([{ src: html, type: "html", caption: escapeHTML(caption) }]);
        return;
      }
      if (file.previewKind === "pdf" || file.previewKind === "iframe") {
        window.Fancybox.show([{ src: file.downloadURL, type: "iframe", caption: escapeHTML(caption), preload: false }]);
        return;
      }
      if (file.previewKind === "text") {
        const html = "<div class=\"max-w-3xl text-left\"><pre class=\"max-h-[70vh] overflow-auto whitespace-pre-wrap break-words rounded-2xl bg-slate-900/70 p-4 text-xs leading-relaxed text-slate-100\">加载中...</pre></div>";
        window.Fancybox.show([{ src: html, type: "html", caption: escapeHTML(caption) }], {
          dragToClose: false,   // 1. 关掉拖动关闭
          contentClick: false,  // 2. 点击内容不关闭
          groupAll: false,      // 3. 禁止左右滑动切图
        });
        fetch(file.downloadURL)
          .then((response) => {
            if (!response.ok) {
              throw new Error("fetch failed");
            }
            return response.text();
          })
          .then((text) => {
            const limited = text.length > 60000 ? text.slice(0, 60000) + "\n...（内容已截断）" : text;
            const pre = document.querySelector(".fancybox__content pre");
            if (pre) {
              pre.textContent = limited;
            }
          })
          .catch(() => {
            window.open(file.downloadURL, "_blank");
          });
        return;
      }
      window.open(file.downloadURL, "_blank");
    }

    function showPreviewUnavailableModal(file) {
      els.modalFilename.textContent = file.fileName;
      els.modalDownload.href = file.downloadURL;
      els.modalDownload.setAttribute("download", sanitize(file.fileName) || "download");
      els.modal.classList.remove("hidden");
      
      // 阻止背景滚动
      document.body.style.overflow = "hidden";
    }

    function hidePreviewUnavailableModal() {
      els.modal.classList.add("hidden");
      
      // ...
      document.body.style.overflow = "";
    }

    function scrollToAndHighlightFile(fileName) {
      // 查找包含指定文件名的行
      const rows = els.explorerRows.querySelectorAll('tr');
      let targetRow = null;
      
      for (const row of rows) {
        const nameCell = row.querySelector('.name-cell span');
        if (nameCell && nameCell.textContent === fileName) {
          targetRow = row;
          break;
        }
      }
      
      if (targetRow) {
        // 滚动到目标行
        targetRow.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        
        // 添加闪烁高亮效果
        targetRow.classList.add('jump-highlight');
        
        // 1秒后移除高亮效果
        setTimeout(() => {
          targetRow.classList.remove('jump-highlight');
        }, 1000);
      }
    }

    function fetchData() {
      const url = "./" + String(DASHBOARD_DATA_FILE).replace(/^\.\//, "");
      return fetch(url, { cache: "no-cache" }).then((response) => {
        if (!response.ok) {
          throw new Error("加载数据失败: " + response.status);
        }
        return response.json();
      });
    }

    function updateGeneratedAt(label) {
      if (!label) {
        els.generatedAt.textContent = "尚未生成数据";
        return;
      }
      els.generatedAt.textContent = "数据生成时间：" + label;
    }

    function bootstrap() {
      setLoading(true);
      fetchData()
        .then((data) => {
          updateGeneratedAt(data && data.generatedAt ? data.generatedAt : "");
          const merged = mergeGroups(normalizeConfigs(CONFIG_GROUPS), extractGroups(data));
          state.groups = merged;
          buildSearchIndex(merged);
          if (!merged.length) {
            state.activeGroupId = null;
            state.activePath = "";
            renderGroupList();
            renderExplorer();
            return;
          }
          const current = state.activeGroupId && merged.find((group) => group.id === state.activeGroupId);
          if (current) {
            renderGroupList();
            renderExplorer();
          } else {
            setActiveGroup(merged[0].id);
          }
        })
        .catch((error) => {
          console.error(error);
          const message = "加载仪表盘数据失败：" + error.message;
          els.generatedAt.textContent = message;
          els.groupList.innerHTML = "";
          els.groupEmpty.classList.remove("hidden");
          els.groupEmpty.textContent = message;
          els.explorerRows.innerHTML = "";
          els.explorerEmpty.classList.remove("hidden");
          els.explorerEmpty.textContent = message;
        })
        .finally(() => {
          setLoading(false);
        });
    }

    function applyTheme(themeOverride) {
      const t = (themeOverride === "light" || themeOverride === "dark") ? themeOverride : "";
      if (t) {
        document.documentElement.setAttribute("data-theme", t);
      } else {
        document.documentElement.removeAttribute("data-theme");
      }
      const prefersDark = !!(window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches);
      const effective = t ? t : (prefersDark ? "dark" : "light");
      if (els.themeLabel) {
        els.themeLabel.textContent = effective === "dark" ? "深色" : "浅色";
      }
    }

    function nextTheme(themeOverride) {
      const t = (themeOverride === "light" || themeOverride === "dark") ? themeOverride : "";
      const prefersDark = !!(window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches);
      const effective = t ? t : (prefersDark ? "dark" : "light");
      return effective === "dark" ? "light" : "dark";
    }

    function applyUIState() {
      state.sortBy = readPref("qqfs_sort_by", "name");
      state.sortDir = readPref("qqfs_sort_dir", "asc");
      state.theme = readPref("qqfs_theme", "");
      if (state.theme !== "light" && state.theme !== "dark") {
        state.theme = "";
      }

      if (els.sortBy) {
        els.sortBy.value = state.sortBy;
      }
      if (els.sortDir) {
        els.sortDir.textContent = state.sortDir === "desc" ? "降序" : "升序";
      }
      applyTheme(state.theme);

      if (!state._themeMqlBound && window.matchMedia) {
        state._themeMqlBound = true;
        const mql = window.matchMedia("(prefers-color-scheme: dark)");
        const handler = () => {
          if (!state.theme) {
            applyTheme("");
          }
        };
        try {
          mql.addEventListener("change", handler);
        } catch {
          // Safari
          mql.addListener(handler);
        }
      }
    }

    function bindUIControls() {
      if (els.sortBy) {
        els.sortBy.addEventListener("change", () => {
          state.sortBy = els.sortBy.value;
          writePref("qqfs_sort_by", state.sortBy);
          renderExplorer();
        });
      }
      if (els.sortDir) {
        els.sortDir.addEventListener("click", () => {
          state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
          writePref("qqfs_sort_dir", state.sortDir);
          els.sortDir.textContent = state.sortDir === "desc" ? "降序" : "升序";
          renderExplorer();
        });
      }
      if (els.themeBtn) {
        els.themeBtn.addEventListener("click", () => {
          const t = nextTheme(state.theme);
          state.theme = t;
          writePref("qqfs_theme", t);
          applyTheme(t);
        });
      }

      // 快捷键：/ 聚焦搜索
      document.addEventListener("keydown", (event) => {
        if (event.key === "/" && document.activeElement !== els.search && !event.ctrlKey && !event.metaKey && !event.altKey) {
          event.preventDefault();
          els.search.focus();
        }
      });
    }

    els.search.addEventListener("input", () => window.requestAnimationFrame(handleSearch));
    els.search.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        clearSearch();
      }
    });
    els.searchClear.addEventListener("click", clearSearch);
    els.refresh.addEventListener("click", () => {
      clearSearch();
      bootstrap();
    });

    // Modal事件监听器
    els.modalClose.addEventListener("click", hidePreviewUnavailableModal);
    els.modalCancel.addEventListener("click", hidePreviewUnavailableModal);
    
    // 点击modal背景关闭
    els.modal.addEventListener("click", (event) => {
      if (event.target === els.modal) {
        hidePreviewUnavailableModal();
      }
    });
    
    // ESC键关闭modal
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && !els.modal.classList.contains("hidden")) {
        hidePreviewUnavailableModal();
      }
    });

    applyUIState();
    bindUIControls();

bootstrap();
  </script>
</body>
</html>